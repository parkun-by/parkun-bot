# Getting started for developers

>Disclaimer
>
>Инструкция написана для linux (проверялась на debian). Адаптация этой инструкции для windows или macOS не планируется, но будет с благодарностью принята, если найдутся желающие адаптировать.
>
>То же самое касается перевода инструкции на другие языки.

В данный момент система состоит из трех основных репозиториев:

- [сам бот](https://github.com/parkun-by/parkun-bot)
- [отправитель обращений](https://github.com/parkun-by/appeal_sender)
- [расшариватель по соцсетям](https://github.com/parkun-by/broadcaster)

Подробнее про архитектуру паркуна можно почитать [здесь](./parkun_arch.md).

Посему и разворот бота состоит из трех больших шагов:

- разворот бота
- разворот отправителя обращений (опционально)
- разворот расшаривателя (опционально)

Для всего этого вам точно понадобится:

- gcc
- git
- docker
- docker-compose
- python (конкретная версия указана в файле [.tool-versions](../../.tool-versions))

## Разворот бота

Для начала нужно клонировать бота себе на компьютер:

```sh
git clone https://github.com/parkun-by/parkun-bot.git
```

В репозитории две ветки: master и develop. Для разработки какой-то фичи или исправления ошибки вам нужно создать собственную ветку на основе ветки develop:

```sh
cd parkun-bot
git checkout develop
git checkout -b my-new-feature
```

Далее нужно задать токен своего тестового бота в [конфиге](../../config.py), который лежит в корне проекта (как зарегистрировать бота можно посмотреть в интернете. Например, [здесь](https://way23.ru/%D1%80%D0%B5%D0%B3%D0%B8%D1%81%D1%82%D1%80%D0%B0%D1%86%D0%B8%D1%8F-%D0%B1%D0%BE%D1%82%D0%B0-%D0%B2-telegram/)).

Заменяем строку `PUT_TOKEN_HERE` на свой токен.

Указываем в `ADMIN_ID` свой telegram id, который можно получить послав специальному [боту](t.me/userinfobot) в телеграме какое-нибудь сообщение.

В `CHANNEL` и `TRASH_CHANNEL` указываем ваш канал, который вам нужно завести в телеграме и добавить в нем вашего бота администратором. Для разработки эти два канала могут быть одинаковыми.

В настройках telegra.ph (они с префиксом `TPH_`) нужно указать информацию, которую можно получить запросом

```url
https://api.telegra.ph/createAccount?short_name=Sandbox&author_name=Anonymous
```

С конфигом покончено.

Разворачиваем питонье окружение магической [командой](../../Makefile). Она создаст окружение и установит зависимости:

```sh
make py_env
```

Активируем питонье окружение:

```sh
source .venv/bin/activate
```

Второй магической командой поднимаем окружение бота в docker-контейнерах:

```sh
make start_dev
```

Этой командой у вас поднимется очередь (RabbitMQ), хранилище (Redis) и сервер заглушек для некоторых вспомогательных сервисов.

Запускаем, наконец, бота:

```sh
python main.py
```

После этого можно проверять в телеграме, что ваш бот жив и легитимен. Дорабатывать бота частично можно и без отправителя. Зависит от того, что нужно сделать.

## Разворот отправителя обращений

>Нужен только если нужно разрабатывать отправитель или какие-то вещи в боте после отправки или расшариватель.

Клонируем репозиторий отправителя:

```sh
git clone https://github.com/parkun-by/appeal_sender.git
```

В репозитории две ветки: master и develop. Для разработки какой-то фичи или исправления ошибки вам нужно создать собственную ветку на основе ветки develop:

```sh
cd appeal_sender
git checkout develop
git checkout -b my-new-feature
```

Разворачиваем питонье окружение магической командой. Она создаст окружение и установит зависимости:

```sh
make py_env
```

Активируем питонье окружение:

```sh
source .venv/bin/activate
```

Второй магической командой поднимаем окружение отправителя в docker-контейнерах:

```sh
make start_dev
```

Запустится headless firefox и распознаватель капчи.

Далее нужно задать свой тестовый адрес email и пароль в [конфиге](https://github.com/parkun-by/appeal_sender/blob/master/config.py), который лежит в корне проекта. Пока что почта должна хоститься на [outlook.com](outlook.com).

 При каждом запуске отправитель будет выбирать случайный адрес и списка `EMAILS`. Пароль на них всех общий в поле `EMAIL_PWD`. Для разработки хватает одного, как правило.

Запускаем отправителя:

```sh
python main.py
```

Запустится отправитель.

## Разворот расшаривателя нарушений

>Нужен если нужно дорабатывать сам расшариватель. Бот и отправитель могут отбходиться без него кроме того, что не будут чиститься временные файлы.

TODO
